<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" />
	<script src="http://leafletjs.com/dist/leaflet.js"></script>
	<script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>

	<script src="../src/L.ImageTransform.js"></script>
</head>
<body>
	<div id="map" style="width: 800px; height: 600px; border: 1px solid #ccc"></div>

	<script>
		var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png',
			cloudmade = new L.TileLayer(cloudmadeUrl, {maxZoom: 18}),
			map = new L.Map('map', {layers: [cloudmade], center: new L.LatLng(56, 137.3), zoom: 9});

        var anchors = [[56.344192, 136.59558], [56.344192, 137.8782], [55.613245, 137.8782], [55.613245, 136.59558]]; // TopLeft, TopRight, BottomRight, BottomLeft on image
        var options = {
            opacity: 0.5
            ,
            clip: [[56.301281, 136.90579],[56.150009, 137.83902],[55.639533, 137.53169],[55.788635, 136.60979],[56.301281, 136.90579]]  // clip polygon
        };
        var gmxImage = new L.ImageTransform('image.jpg', anchors, options);
		map.addLayer(gmxImage);

		// To modify the anchor points on image
        L.gmxPolygon = L.Polygon.extend({
            disableAddRemovePoints: function () {
                var poly = this.editing._poly;
                for(var key in this.editing._markerGroup._layers) {
                    var marker = this.editing._markerGroup._layers[key];
                    if(marker._index === undefined) marker._icon.style.display = 'none';
                    else {
                        marker.off('click');
                        marker.on('drag', function (ev){poly.fire('drag');}, this);
                    }
                }
            }
        });
        var polygon = new L.gmxPolygon(anchors, { fillOpacity: 0 });
		polygon.editing.enable();
		map.addLayer(polygon);
		polygon.disableAddRemovePoints();
		polygon.on('edit', function() {
			//console.log('Polygon was edited!', arguments);
            //gmxImage.setClip(options.clip);
		});
		polygon.on('drag', function(ev) {
			//console.log('drag', arguments);
            //gmxImage.setClip();
            var newAnchors = [];
            for(var i = 0, len = ev.target._latlngs.length; i < len; i++) {
                var marker = ev.target._latlngs[i];
                newAnchors.push([marker.lat, marker.lng]);
            }
            gmxImage.setAnchors(newAnchors);
		});
	</script>
</body>
</html>
